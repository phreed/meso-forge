# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json
schema_version: 1

context:
  version: 2025.2.0

package:
  name: bitwarden-cli
  version: ${{ version }}

source:
  url: https://github.com/bitwarden/clients/archive/refs/tags/cli-v${{ version }}.tar.gz
  sha256: 2c31f8f66e197d5bcbc656c258d4556c97e49a940cabad3ec76ff3742b5252c7

build:
  number: 0
  noarch: generic
  script: |
    # Remove problematic postinstall script from desktop app
    sed -i 's/"postinstall": "electron-rebuild",/"postinstall": "echo Skipping electron-rebuild",/' apps/desktop/package.json

    # Install dependencies following GitHub Actions workflow pattern
    npm ci

    # Build CLI app (JavaScript files instead of bundled executable)
    cd apps/cli
    npm run build:oss:prod

    # Copy built JavaScript files and dependencies to package
    mkdir -p $PREFIX/lib/bitwarden-cli
    cp -r build/* $PREFIX/lib/bitwarden-cli/

    # Copy required node_modules to the package
    cd ../..
    mkdir -p $PREFIX/lib/bitwarden-cli/node_modules
    cp -r node_modules/* $PREFIX/lib/bitwarden-cli/node_modules/

    # Create wrapper script that sets NODE_PATH
    mkdir -p $PREFIX/bin
    echo '#!/bin/bash' > $PREFIX/bin/bw
    echo 'export NODE_PATH="$PREFIX/lib/bitwarden-cli/node_modules:$NODE_PATH"' >> $PREFIX/bin/bw
    echo 'exec node "$PREFIX/lib/bitwarden-cli/bw.js" "$@"' >> $PREFIX/bin/bw
    chmod +x $PREFIX/bin/bw

requirements:
  build:
    - yarn
    - webpack-cli
  host:
    - nodejs
    - jest

  run:
    - nodejs

tests:
  - script:
      - bw --version

about:
  homepage: https://bitwarden.com/help/cli/
  summary: The Bitwarden command-line interface (CLI)
  description: |
    The Bitwarden command-line interface (CLI) is a powerful,
    fully-featured tool for accessing and managing your vault.
    Most features that you find in other Bitwarden client applications
    (desktop, browser extension, etc.)
    are available from the CLI.
    https://contributing.bitwarden.com/getting-started/clients/cli/
  license: Apache-2.0
  license_file: LICENSE.txt
  repository: https://github.com/bitwarden/clients/tree/main/apps/cli

extra:
  recipe-maintainers:
    - phreed
