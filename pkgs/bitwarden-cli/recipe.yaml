# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json
schema_version: 1

context:
  version: 2025.2.0

package:
  name: bitwarden-cli
  version: ${{ version }}

source:
  url: https://github.com/bitwarden/clients/archive/refs/tags/cli-v${{ version }}.tar.gz
  sha256: 2c31f8f66e197d5bcbc656c258d4556c97e49a940cabad3ec76ff3742b5252c7

build:
  number: 0
  noarch: generic
  script:
    interpreter: nu
    content: |
      # Remove problematic postinstall script from desktop app
      ^sed -i 's/"postinstall": "electron-rebuild",/"postinstall": "echo Skipping electron-rebuild",/' apps/desktop/package.json

      # Install dependencies following GitHub Actions workflow pattern
      ^npm ci

      # Build CLI app (JavaScript files instead of bundled executable)
      cd apps/cli
      ^npm run build:oss:prod

      # Copy built JavaScript files and dependencies to package
      let lib_dir = ($env.PREFIX | path join "lib" "bitwarden-cli")
      ^mkdir -p $lib_dir
      ^cp -r build/* $lib_dir

      # Copy required node_modules to the package
      cd ../..
      let node_modules_dir = ($lib_dir | path join "node_modules")
      ^mkdir -p $node_modules_dir
      ^cp -r node_modules/* $node_modules_dir

      # Create wrapper script that sets NODE_PATH
      let bin_dir = ($env.PREFIX | path join "bin")
      ^mkdir -p $bin_dir
      let wrapper_script = ($bin_dir | path join "bw")

      let script_content = "#!/bin/bash" + "\n" + "export NODE_PATH=\"$PREFIX/lib/bitwarden-cli/node_modules:$NODE_PATH\"" + "\n" + "exec node \"$PREFIX/lib/bitwarden-cli/bw.js\" \"$@\""

      $script_content | save $wrapper_script
      ^chmod +x $wrapper_script

requirements:
  build:
    - nushell
    - yarn
    - webpack-cli
  host:
    - nodejs
    - jest

  run:
    - nodejs

tests:
  # Test 1: Verify package contents are included
  - package_contents:
      files:
        # Bitwarden CLI wrapper script
        - ${{ "Library/" if win }}bin/bw${{ ".bat" if win }}
        # JavaScript application files
        - ${{ "Library/" if win }}lib/bitwarden-cli/bw.js
        - ${{ "Library/" if win }}lib/bitwarden-cli/node_modules/

  # Test 2: Functional tests
  - requirements:
      build:
        - nushell
    script:
      interpreter: nu
      content:
        - ^bw --version

about:
  homepage: https://bitwarden.com/help/cli/
  summary: The Bitwarden command-line interface (CLI)
  description: |
    The Bitwarden command-line interface (CLI) is a powerful,
    fully-featured tool for accessing and managing your vault.
    Most features that you find in other Bitwarden client applications
    (desktop, browser extension, etc.)
    are available from the CLI.
    https://contributing.bitwarden.com/getting-started/clients/cli/
  license: Apache-2.0
  license_file: LICENSE.txt
  repository: https://github.com/bitwarden/clients/tree/main/apps/cli

extra:
  recipe-maintainers:
    - phreed
